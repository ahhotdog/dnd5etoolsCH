"use strict";const BookUtil={scrollClick:(e,t)=>{const o=[`div.statsBlockSectionHead > span.entry-title:textEquals("${e}")`,`div.statsBlockHead > span.entry-title:textEquals("${e}")`,`div.statsBlockSubHead > span.entry-title:textEquals("${e}")`,`div.statsBlockInset > span.entry-title:textEquals("${e}")`,`div.statsInlineHead > span.entry-title:textEquals("${e}.")`];if(void 0===t){const e=$(o[0]);if(e.length)return void e[0].scrollIntoView();const t=$(o[1]);if(t.length)return void t[0].scrollIntoView();const n=$(o[2]);if(n.length)return void n[0].scrollIntoView();const i=$(o[3]);i.length&&i[0].scrollIntoView();const l=$(o[4]);l.length&&l[0].scrollIntoView()}else{const e=$(`${o[0]}, ${o[1]}, ${o[2]}, ${o[3]}, ${o[4]}`);e.length&&(e[t]?e[t].scrollIntoView():e[0].scrollIntoView())}},scrollPageTop:()=>{$("#pagecontent")[0].scrollIntoView()},makeContentsBlock:e=>{let t=`<ul class="bk-contents" ${e.defaultHidden?'style="display: none;"':""}>`;return e.book.contents.forEach((o,n)=>{t+=`<li>\n\t\t\t\t<a href="${e.addPrefix||""}#${e.book.id},${n}" ${e.addOnclick?'onclick="BookUtil.scrollPageTop()"':""}>\n\t\t\t\t\t<span class="sect">${BookUtil.getOrdinalText(o.ordinal)}${o.name}</span>\n\t\t\t\t</a>\n\t\t\t</li>`,t+=BookUtil.makeHeadersBlock(e.book.id,n,o,e.addPrefix,e.addOnclick,e.defaultHeadersHidden)}),t+="</ul>"},getOrdinalText:e=>void 0===e?"":`${"part"===e.type?`Part ${e.identifier} — `:"chapter"===e.type?`Ch. ${e.identifier}: `:"episode"===e.type?`Ep. ${e.identifier}: `:`App. ${e.identifier}: `}`,makeHeadersBlock:(e,t,o,n,i,l)=>{let r=`<ul class="bk-headers" ${l?'style="display: none;"':""}>`;return o.headers&&o.headers.forEach(o=>{r+=`<li>\n\t\t\t\t<a href="${n||""}#${e},${t},${UrlUtil.encodeForHash(o)}" data-book="${e}" data-chapter="${t}" data-header="${o}" ${i?`onclick="BookUtil.scrollClick('${o.replace(/'/g,"\\'")}')"`:""}>${o}</a>\n\t\t\t</li>`}),r+="</ul>"},addHeaderHandles:e=>{const t=$("ul.bk-headers");t.prev("li").find("a").css({display:"flex","justify-content":"space-between",padding:"0"}),t.filter((e,t)=>$(t).children().length).each((t,o)=>{$(o).prev("li").find("a").append(`<span class="showhide" onclick="BookUtil.sectToggle(event, this)" data-hidden="true">${e?"[+]":"[–]"}</span>`)})},sectToggle:(e,t)=>{e&&(e.stopPropagation(),e.preventDefault());const o=$(t),n=o.closest("li").next("ul.bk-headers");o.data("hidden")?(n.show(),o.data("hidden",!1),o.html("[–]")):(n.hide(),o.data("hidden",!0),o.html("[+]"))},thisContents:null,curRender:{curAdvId:"NONE",chapter:-1,data:{}},showBookContent:(e,t,o,n)=>{function i(){$("div.statsBlockSectionHead").show(),$("hr.section-break").show()}function l(e){if(e){const t=$("div.statsBlockSectionHead");t.hide(),$("hr.section-break").hide(),t.filter((t,o)=>{return $(o).children().filter(`span.entry-title:textEquals("${e}")`).length}).show()}else i()}let r,a,s=0,d=!1;if(n&&n.length>0&&(s=Number(n[0])),n&&n.length>1?(r=$(`[href="#${o},${s},${n[1]}"]`).data("header"),BookUtil.referenceId&&l(r),r||(r=decodeURIComponent(n[1]),n[2]&&(a=Number(n[2])),d=!0)):BookUtil.referenceId&&i(),BookUtil.curRender.data=e,BookUtil.curRender.chapter!==s||BookUtil.curRender.curAdvId!==o){BookUtil.thisContents.children("ul").children("ul, li").removeClass("active"),BookUtil.thisContents.children("ul").children(`li:nth-of-type(${s+1}), ul:nth-of-type(${s+1})`).addClass("active");const t=BookUtil.thisContents.children("ul").children(`li:nth-of-type(${s+1})`).find(".showhide");t.data("hidden")&&t.click(),BookUtil.curRender.curAdvId=o,BookUtil.curRender.chapter=s,BookUtil.renderArea.html(""),BookUtil.renderArea.append(EntryRenderer.utils.getBorderTr());const n=[];BookUtil._renderer.setFirstSection(!0),BookUtil._renderer.recursiveEntryRender(e[s],n),BookUtil.renderArea.append(`<tr class='text'><td colspan='6'>${n.join("")}</td></tr>`),BookUtil.renderArea.append(EntryRenderer.utils.getBorderTr()),r&&(BookUtil.referenceId&&l(r),setTimeout(()=>{BookUtil.scrollClick(r,a)},75))}else n.length<=1?BookUtil.scrollPageTop():d&&BookUtil.scrollClick(r,a)},indexListToggle:(e,t)=>{e&&(e.stopPropagation(),e.preventDefault());const o=$(t),n=o.closest("li").find("ul.bk-contents");o.data("hidden")?(n.show(),o.data("hidden",!1),o.html("[–]")):(n.hide(),o.data("hidden",!0),o.html("[+]"))},baseDataUrl:"",bookIndex:[],homebrewIndex:null,homebrewData:null,renderArea:null,referenceId:!1,booksHashChange:()=>{function e(e,t){var i;document.title=`${e.name} - 5etools`,$(".book-head-header").html((i=e.name).includes(Parser.SOURCE_JSON_TO_FULL[SRC_TYP])?i.replace(Parser.SOURCE_JSON_TO_FULL[SRC_TYP],Parser.sourceJsonToAbv(SRC_TYP)):i),$(".book-head-message").html("Browse content. Press F to find."),BookUtil.loadBook(e,o,n,t),currentPage()}function t(){if(window.location.hash)throw $(".initial-message").text(`Loading failed—could not find a book with id "${o}"`),new Error(`No book with ID: ${o}`);window.history.back()}const[o,...n]=window.location.hash.slice(1).split(HASH_PART_SEP),i=BookUtil.bookIndex.find(e=>UrlUtil.encodeForHash(e.id)===UrlUtil.encodeForHash(o));i&&!i.uniqueId?e(i):i&&i.uniqueId?BrewUtil.pAddBrewData().then(n=>{n[BookUtil.homebrewData]||t();const l=(n[BookUtil.homebrewData]||[]).find(e=>UrlUtil.encodeForHash(e.id)===UrlUtil.encodeForHash(o));l||t(),e(i,l)}).catch(()=>{BrewUtil.purgeBrew(),t()}):t()},_renderer:new EntryRenderer,loadBook:(e,t,o,n)=>{function i(n){const i=$(".contents-item");BookUtil.thisContents=i.filter(`[data-bookid="${UrlUtil.encodeForHash(t)}"]`),BookUtil.thisContents.show(),i.filter(`[data-bookid!="${UrlUtil.encodeForHash(t)}"]`).hide(),BookUtil.showBookContent(BookUtil.referenceId?n.data[BookUtil.referenceId]:n.data,e,t,o),BookUtil.addSearch(e,t)}n?i(n):DataUtil.loadJSON(`${BookUtil.baseDataUrl}${t.toLowerCase()}.json`).then(i)},_$body:null,_$findAll:null,_headerCounts:null,_lastHighlight:null,addSearch:(e,t)=>{function o(e){return`${UrlUtil.encodeForHash(t)}${HASH_PART_SEP}${e.ch}${e.header?`${HASH_PART_SEP}${UrlUtil.encodeForHash(e.header)}${HASH_PART_SEP}${e.headerIndex}`:""}`}function n(e){return e.name&&("entries"===e.type||"inset"===e.type||"section"===e.type)}BookUtil._$body=BookUtil._$body||$("body"),BookUtil._$body.on("click",()=>{BookUtil._$findAll&&BookUtil._$findAll.remove()}),BookUtil._$body.off("keypress"),BookUtil._$body.on("keypress",t=>{if("f"===t.key&&noModifierKeys(t)){if("INPUT"===t.target.nodeName||"TEXTAREA"===t.target.nodeName)return;$("span.temp").contents().unwrap(),BookUtil._lastHighlight=null,BookUtil._$findAll&&BookUtil._$findAll.remove(),BookUtil._$findAll=$('<div class="f-all-wrapper"/>').on("click",e=>{e.stopPropagation()});const l=$('<div class="f-all-out">'),r=$('<input class="form-control" placeholder="Find text...">').on("keypress",t=>{if(t.stopPropagation(),"Enter"===t.key&&noModifierKeys(t)){l.html("");const t=[];BookUtil.curRender.data.forEach((e,o)=>{BookUtil._headerCounts={},function e(t,o,l,r,a){if(null==r)return;const s=r.toLowerCase().trim();if(!s)return;n(a)&&(void 0===BookUtil._headerCounts[a.name]?BookUtil._headerCounts[a.name]=0:BookUtil._headerCounts[a.name]++);let d;n(a)?(d=a.name).toLowerCase().includes(s)&&l.push({ch:t,header:d,headerIndex:BookUtil._headerCounts[d],term:r.trim(),headerMatches:!0}):d=o;if(a.entries)a.entries.forEach(o=>e(t,d,l,r,o));else if(a.items)a.items.forEach(o=>e(t,d,l,r,o));else if(a.rows)a.rows.forEach(o=>{const n=o.row?o.row:o;n.forEach(o=>e(t,d,l,r,o))});else if(a.entry)e(t,d,l,r,a.entry);else if("string"==typeof a||"number"==typeof a){const e=[];BookUtil._renderer.recursiveEntryRender(a,e);const o=$(`<p>${e.join("")}</p>`).text(),n="number"==typeof a?String(o):o.toLowerCase();if(n.includes(s))if(l.length&&l[l.length-1].header===d&&l[l.length-1].headerIndex===BookUtil._headerCounts[d]&&l[l.length-1].previews){const e=n.lastIndexOf(s),t=c(o,e,e+s.length),i=l[l.length-1];i.previews[1]=t.preview,i.matches[1]=t.match}else{const e=n.indexOf(s),i=n.lastIndexOf(s),a=[];e===i?a.push(c(o,e,e)):(a.push(c(o,e,e+s.length)),a.push(c(o,i,i+s.length))),l.push({ch:t,header:d,headerIndex:BookUtil._headerCounts[d],previews:a.map(e=>e.preview),term:r.trim(),matches:a.map(e=>e.match),headerMatches:d.toLowerCase().includes(s)})}}else if("image"!==a.type&&"link"!==a.type&&"abilityGeneric"!==a.type)throw new Error("Unhandled entity type");function c(e,t,o){let n=0,l="",a=t-1;for(;a>=0&&(l=e.charAt(a)+l," "===e.charAt(a)&&n++,!(n>i));--a);l=l.ltrim();const d=a>0;n=0;let c="";const h=t===o?o+s.length:o;for(a=Math.min(h,e.length);a<e.length&&(c+=e.charAt(a)," "===e.charAt(a)&&n++,!(n>i));++a);c=c.rtrim();const p=a<e.length,$=e.substr(t,r.length);return{preview:`${d?"...":""}${l}<span class="highlight">${$}</span>${c}${p?"...":""}`,match:`${l}${r}${c}`}}}(o,"",t,r.val(),e)}),t.length?(l.show(),t.forEach(t=>{const n=$('<p class="f-result"/>'),i=$("<span/>"),r=$(`<a href="#${o(t)}">\n\t\t\t\t\t\t\t\t\t<i>${BookUtil.getOrdinalText(e.contents[t.ch].ordinal)} ${e.contents[t.ch].name}${t.header?` – ${t.headerMatches?'<span class="highlight">':""}${t.header}${t.headerMatches?"</span>":""}`:""}</i>\n\t\t\t\t\t\t\t\t</a>`);if(i.append(r),n.append(i),t.previews){const e=$(`<a href="#${o(t)}"/>`),i=new RegExp(RegExp.escape(t.term),"gi");e.on("click",()=>{setTimeout(()=>{null!==BookUtil._lastHighlight&&BookUtil._lastHighlight===t.term.toLowerCase()||(BookUtil._lastHighlight=t.term,$("#pagecontent").find(`p:containsInsensitive("${t.term}"), li:containsInsensitive("${t.term}"), td:containsInsensitive("${t.term}"), a:containsInsensitive("${t.term}")`).each((e,t)=>{$(t).html($(t).html().replace(i,"<span class='temp highlight'>$&</span>"))}))},15)}),e.append(`<span>${t.previews[0]}</span>`),t.previews[1]&&(e.append(" ... "),e.append(`<span>${t.previews[1]}</span>`)),n.append(e),r.on("click",()=>e.click())}l.append(n)})):l.hide()}});BookUtil._$findAll.append(r).append(l),BookUtil._$body.append(BookUtil._$findAll),r.focus(),setTimeout(()=>{r.val("")},5)}});const i=2}};