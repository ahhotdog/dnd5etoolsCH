const Omnisearch={_PLACEHOLDER_TEXT:"Search everywhere...",_searchIndex:null,_onFirstLoad:null,_loadingSearch:!1,_CATEGORY_COUNTS:{},highestId:-1,init:init=function(){const e=$("#navbar");e.append(`\n\t\t\t<div class="input-group" id="wrp-omnisearch-input">\n\t\t\t\t<input id="omnisearch-input" class="form-control" placeholder="${Omnisearch._PLACEHOLDER_TEXT}" title="Disclaimer: unlikely to search everywhere. Use with caution.">\n\t\t\t\t<div class="input-group-btn">\n\t\t\t\t\t<button class="btn btn-default" id="omnisearch-submit" tabindex="-1"><span class="glyphicon glyphicon-search"></span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`),e.after('<div id="omnisearch-output-wrapper"><div id="omnisearch-output"></div></div>');const t=$("#omnisearch-output-wrapper"),n=$("#omnisearch-output"),a=$("#omnisearch-input"),s=$("#omnisearch-submit");let i=!1;$("body").on("click",()=>{t.hide()}),n.on("click",e=>{e.stopPropagation()}),a.on("keydown",e=>{switch(e.which){case 13:i=!0,s.click();break;case 37:e.preventDefault(),$(".pg-left").click();break;case 38:e.preventDefault();break;case 39:e.preventDefault(),$(".pg-right").click();break;case 40:e.preventDefault(),n.find("a").first().focus()}e.stopPropagation()});let c;a.on("keyup",e=>{e.which>=37&&e.which<=40||(clearTimeout(c),c=setTimeout(()=>{s.click()},100))}),a.on("keydown",()=>{clearTimeout(c)}),a.on("click",e=>{a.val()&&a.val().trim().length&&s.click(),e.stopPropagation()}),s.on("click",e=>{e.stopPropagation(),o()}),$(window).on("scroll",()=>{$(window).width()<768?(a.attr("placeholder",Omnisearch._PLACEHOLDER_TEXT),$("#wrp-omnisearch-input").removeClass("scrolled"),n.removeClass("scrolled")):$(window).scrollTop()>50?(a.attr("placeholder",""),$("#wrp-omnisearch-input").addClass("scrolled"),n.addClass("scrolled")):(a.attr("placeholder",Omnisearch._PLACEHOLDER_TEXT),$("#wrp-omnisearch-input").removeClass("scrolled"),n.removeClass("scrolled"))});const r=15;function o(){if(!Omnisearch._searchIndex)return Omnisearch.doSearchLoad(),void(Omnisearch._onFirstLoad=o);const e=a.val(),s=elasticlunr.tokenizer(e).map(e=>{const t=Object.keys(Omnisearch._CATEGORY_COUNTS).map(e=>e.toLowerCase()).find(t=>`in:${t}`===e.toLowerCase().trim()||`in:${t}s`===e.toLowerCase().trim());return{t:e,isCat:!!t,c:t}});let c=0;const f=s.filter(e=>e.isCat);let g;if(1===f.length){const e=s.filter(e=>!e.isCat).map(e=>e.t);g=Omnisearch._searchIndex.search(e.join(" "),{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0}).filter(e=>f[0].c&&e.doc.cf.toLowerCase()===f[0].c.toLowerCase())}else g=Omnisearch._searchIndex.search(e,{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0});u()||(g=g.filter(e=>e.doc.s&&!SourceUtil._isNonstandardSourceWiz(e.doc.s))),g.length?function e(){n.empty();const a=u();const s=$(`<button class="btn btn-default btn-xs btn-file" title="Filter Unearthed Arcana and other unofficial source results" tabindex="-1">${a?"Exclude":"Include"} UA, etc</button>`).on("click",()=>{!function(e){d=e?h:p,Cookies.set(l,d,{expires:365})}(!a),o()});n.append($('<div class="text-align-right"/>').append(s));const f=c*r;for(let e=f;e<Math.max(Math.min(g.length,r+f),f);++e){const t=g[e].doc;n.append(`\n\t\t\t\t<p>\n\t\t\t\t\t<a href="${UrlUtil.categoryToPage(t.c)}#${t.u}" ${t.h?(m=t.c,v=t.u,O=t.s,`onmouseover="EntryRenderer.hover.mouseOver(event, this, '${UrlUtil.categoryToPage(m)}', '${O}', '${v.replace(/'/g,"\\'")}')"`):""} onkeydown="Omnisearch.handleLinkKeyDown(event, this)">${t.cf}: ${t.n}</a>\n\t\t\t\t\t${t.s?`<i title="${Parser.sourceJsonToFull(t.s)}">${Parser.sourceJsonToAbv(t.s)}${t.p?` p${t.p}`:""}</i>`:""}\n\t\t\t\t</p>`)}var m,v,O;t.css("display","flex");if(g.length>r){const t=$('<div class="omnisearch-pagination-wrapper">');if(c>0){const n=$('<span class="pg-left has-results-left pg-control"><span class="glyphicon glyphicon-chevron-left"></span></span>').on("click",()=>{c--,e()});t.append(n)}else t.append('<span class="pg-left">');if(t.append(`<span class="pg-count">Page ${c+1}/${Math.ceil(g.length/r)} (${g.length} results)</span>`),g.length-c*r>r){const n=$('<span class="pg-right has-results-right pg-control"><span class="glyphicon glyphicon-chevron-right"></span></span>').on("click",()=>{c++,e()});t.append(n)}else t.append('<span class="pg-right pg-control">');n.append(t)}i&&n.find("a").first()[0].click()}():(n.empty(),t.hide())}const l="search-ua-etc",h="SHOW",p="HIDE";let d;function u(){return d||(d=Cookies.get(l)),d!==p}},doSearchLoad:function(){Omnisearch._loadingSearch||(Omnisearch._loadingSearch=!0,DataUtil.loadJSON("search/index.json").then(e=>{Omnisearch.onSearchLoad(e),Omnisearch._onFirstLoad(),Omnisearch._loadingSearch=!1}))},onSearchLoad:function(e){elasticlunr.clearStopWords(),Omnisearch._searchIndex=elasticlunr(function(){this.addField("n"),this.addField("cf"),this.addField("s"),this.setRef("id")});const t=e=>{e.cf=Parser.pageCategoryToFull(e.c),Omnisearch._CATEGORY_COUNTS[e.cf]?Omnisearch._CATEGORY_COUNTS[e.cf]++:Omnisearch._CATEGORY_COUNTS[e.cf]=1,Omnisearch._searchIndex.addDoc(e)};e.forEach(t),Omnisearch.highestId=e[e.length-1].id,BrewUtil.getSearchIndex().forEach(t)},handleLinkKeyDown(e,t){switch(e.which){case 37:e.preventDefault(),$(".has-results-left").length&&($(".pg-left").click(),$("#omnisearch-output").find("a").first().focus());break;case 38:e.preventDefault(),$(t).parent().prev().find("a").length?$(t).parent().prev().find("a").focus():$(".has-results-left").length&&($(".pg-left").click(),$("#omnisearch-output").find("a").last().focus());break;case 39:e.preventDefault(),$(".has-results-right").length&&($(".pg-right").click(),$("#omnisearch-output").find("a").first().focus());break;case 40:e.preventDefault(),$(t).parent().next().find("a").length?$(t).parent().next().find("a").focus():$(".has-results-right").length&&($(".pg-right").click(),$("#omnisearch-output").find("a").first().focus())}}};window.addEventListener("load",Omnisearch.init);