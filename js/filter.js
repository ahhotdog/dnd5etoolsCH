"use strict";class FilterBox{static getSelectedSources(){const t=StorageUtil.getForPage(FilterBox._STORAGE_NAME);if(t){const e=t[FilterBox.SOURCE_HEADER];if(e){const t=e._totals;return delete e._totals,t.yes||t.no?t.yes?Object.keys(e).filter(t=>1===e[t]):t.no?Object.keys(e).filter(t=>-1!==e[t]):null:Object.keys(e)}return null}return null}constructor(t,e,s){this.inputGroup=t,this.resetButton=e,this.filterList=s,this.headers={},this.$disabledOverlay=$('<div class="list-disabled-overlay"/>'),this.storedValues=StorageUtil.getForPage(FilterBox._STORAGE_NAME),this.$rendered=[],this.dropdownVisible=!1,this.modeAndOr="AND",this.$txtCount=$('<span style="margin-left: auto"/>')}render(){const t=0===this.$rendered.length||History.initialLoad,e=t?null:this.getValues();this._wipeRendered(),this.$list=$("#listcontainer").find(".list");const s=function(){const t=$('<div id="filter-toggle-btn"/>');t.addClass(FilterBox.CLS_INPUT_GROUP_BUTTON);const e=$('<button class="btn btn-default dropdown-toggle" data-toggle="dropdown">篩選 <span class="caret"></span></button>');return t.append(e),t}();this.$miniView=$('<div class="mini-view btn-group"/>');const i=$(this.inputGroup),n=$(`<ul class="${FilterBox.CLS_DROPDOWN_MENU} ${FilterBox.CLS_DROPDOWN_MENU_FILTER}"/>`),a=this,r=$('<li class="filter-item"/>'),o=$('<div class="h-wrap"/>').appendTo(r);if(this.filterList.length>1){const t=$(`<button class="btn btn-default btn-xs" style="width: 3em;">${this.modeAndOr}</button>`).data("andor",this.modeAndOr).on(EVNT_CLICK,()=>{const e="OR"===t.data("andor")?"AND":"OR";a.modeAndOr=e,t.text(e),t.data("andor",e)});o.append("把篩選列別綜合為... ").append('<div style="display: inline-block; width: 10px;"/>').append(t)}o.append(this.$txtCount),this.filterList[0].minimalUI||n.append(r).append(d());for(let t=0;t<this.filterList.length;++t)n.append(l(this,this.filterList[t],this.$miniView)),t<this.filterList.length-1&&n.append(d());function l(t,s,i,n){if(s instanceof MultiFilter){const e=$("<div/>");for(const n of s.filters){const a=l(t,n,i,s.categoryName);e.append(a)}return e}if(s instanceof RangeFilter){const a=$('<li class="filter-item"/>');t.headers[s.header]={outer:a,filter:s};const r=function(){const n=$('<div class="pill-grid"/>'),a=$('<input class="filter-slider"/>').appendTo(n);a.slider({min:s.min,max:s.max,value:[s.min,s.max]}),s.$slider=a;const r=$('<div class="mini-pill" state="ignore"/>'),o=$('<div class="mini-pill" state="ignore"/>');function l(){const[t,e]=a.slider("getValue");t===e?(r.attr("state",FilterBox._PILL_STATES[1]).text(`${s.header} = ${t}`),o.attr("state",FilterBox._PILL_STATES[0])):(t>s.min?r.attr("state",FilterBox._PILL_STATES[1]).text(`${s.header} ≥ ${t}`):r.attr("state",FilterBox._PILL_STATES[0]),e<s.max?o.attr("state",FilterBox._PILL_STATES[1]).text(`${s.header} ≤ ${e}`):o.attr("state",FilterBox._PILL_STATES[0]))}if(a.slider().on("slide",l),r.on(EVNT_CLICK,function(){r.attr("state",FilterBox._PILL_STATES[0]);const[e,i]=a.slider("getValue");a.slider("setValue",[s.min,i]),t._fireValChangeEvent()}).appendTo(i),o.on(EVNT_CLICK,function(){o.attr("state",FilterBox._PILL_STATES[0]);const[e,i]=a.slider("getValue");a.slider("setValue",[e,s.max]),t._fireValChangeEvent()}).appendTo(i),n.data("resetValues",function(){a.slider("setValue",[s.min,s.max]),l()}),n.data("getValues",function(){const t={},[e,s]=a.slider("getValue");return t.min=e,t.max=s,t}),n.data("setValues",function(t){const e=t.filter(t=>t.startsWith("min")).map(t=>t.slice(3)),i=t.filter(t=>t.startsWith("max")).map(t=>t.slice(3));a.slider("setValue",[e.length?Math.max(e[0],s.min):s.min,i.length?Math.min(i[0],s.max):s.max]),l()}),e){const t=e[s.header].min,i=e[s.header].max;a.slider("setValue",[t,i]),l()}else if(t.storedValues&&t.storedValues[s.header]){const e=t.storedValues[s.header].min||s.min,i=t.storedValues[s.header].max||s.max;a.slider("setValue",[e,i]),l()}else n.data("resetValues")();return n}(s.header);t.headers[s.header].ele=r;const o=function(t){const e=$('<div class="h-wrap"/>'),i=($(`<div>${n?`<span class="text-muted">${n}: </span>`:""}${s.header}</div>`).appendTo(e),$('<span class="btn-group quick-btns" style="margin-left: auto;"/>').appendTo(e)),a=$('<button class="btn btn-default btn-xs">Reset</button>').appendTo(i),r=$('<span class="summary" style="margin-left: auto;"/>').appendTo(e),o=$('<span class="include" title="Selected Range"/>').appendTo(r);r.hide();const l=$('<button class="btn btn-default btn-xs show-hide-button" style="margin-left: 5px;">Hide</button>').appendTo(e);return a.on(EVNT_CLICK,function(){t.data("resetValues")()}),l.on(EVNT_CLICK,function(){if(t.is(":hidden"))l.text("Hide"),t.show(),i.show(),r.hide();else{l.text("Show"),t.hide(),i.hide();const e=t.data("getValues")();o.text(e.min===s.min&&e.max===s.max?"":e.min===s.min?`≤ ${e.max}`:e.max===s.max?`≥ ${e.min}`:`${e.min}-${e.max}`),r.show()}}),e}(r);return a.append(o),a.append(r),a}if(s instanceof GroupedFilter||s instanceof Filter){const a=s instanceof GroupedFilter,r=$('<li class="filter-item"/>');t.headers[s.header]={outer:r,filter:s};const o=function(n){const a=[],r=$('<div class="pill-grid"/>'),o=[];let l=0;function d(t){t&&(s.numGroups++,r.append('<hr class="pill-grid-subs-divider">')),o[l]=$('<div class="pill-grid-sub"/>').appendTo(r),l+1<s.numGroups&&r.append('<hr class="pill-grid-subs-divider">'),t&&l++}if(n)for(r.addClass("pill-grid-subs");l<s.numGroups;++l)d();function h(t,e,s){const i=FilterBox._PILL_STATES.indexOf(t.attr("state"));let n=s?i+1:i-1;n>=FilterBox._PILL_STATES.length?n=0:n<0&&(n=FilterBox._PILL_STATES.length-1),t.attr("state",FilterBox._PILL_STATES[n]),e.attr("state",FilterBox._PILL_STATES[n])}for(const l of s.items){const m=l instanceof FilterItem?l.item:l,_=l instanceof FilterItem?l.changeFn:null,x=$('<div class="filter-pill"/>'),g=$('<div class="mini-pill"/>'),b=s.displayFn?s.displayFn(m):m;if(x.val(m),x.html(b),g.html(b),x.attr("state",FilterBox._PILL_STATES[0]),g.attr("state",FilterBox._PILL_STATES[0]),g.on(EVNT_CLICK,function(){x.attr("state",FilterBox._PILL_STATES[0]),g.attr("state",FilterBox._PILL_STATES[0]),p(m,_,FilterBox._PILL_STATES[0]),t._fireValChangeEvent()}),x.on(EVNT_CLICK,function(){h(x,g,!0),p(m,_,x.attr("state"))}),x.on("contextmenu",function(t){t.preventDefault(),h(x,g,!1),p(m,_,x.attr("state"))}),x.data("setter",function(t){c(x,g,t,m,_,!1)}),x.data("resetter",function(){f(x,g,m,_,!1)}),e){let t=e[s.header][m];t<0&&(t=2),c(x,g,FilterBox._PILL_STATES[t],m,_,!0)}else if(t.storedValues&&t.storedValues[s.header]&&void 0!==t.storedValues[s.header][m]){let e=t.storedValues[s.header][m];e<0&&(e=2),c(x,g,FilterBox._PILL_STATES[e],m,_,!0)}else f(x,g,m,_,!0);if(u(g,m),n){const t=Number(l instanceof FilterItem&&null!=l.group?l.group:s.groupFn(m));for(;t>o.length-1;)d(!0);o[t].append(x)}else r.append(x);i.append(g),a.push(x)}function u(t,e){s.deselFn&&s.deselFn(e)?t.addClass("default-desel"):s.selFn&&s.selFn(e)&&t.addClass("default-sel")}function c(t,e,s,i,n,a){t.attr("state",s),e.attr("state",s),a||p(i,n,s)}function f(t,e,i,n,a){s.deselFn&&s.deselFn(i)?(t.attr("state","no"),e.attr("state","no")):s.selFn&&s.selFn(i)?(t.attr("state","yes"),e.attr("state","yes")):(t.attr("state","ignore"),e.attr("state","ignore")),a||p(i,n,t.attr("state"))}function p(t,e,s){e&&e(t,s)}return r.data("getValues",function(){const e={},i={yes:0,no:0,ignored:0};return a.forEach(function(t){const s=t.attr("state");e[t.val()]="yes"===s?1:"no"===s?-1:0;const n="yes"===s?"yes":"no"===s?"no":"ignored";i[n]=i[n]+1}),e._totals=i,e._andOr={blue:t.headers[s.header].getAndOrBlue(),red:t.headers[s.header].getAndOrRed()},e}),r.data("setValues",function(t){const e=t.filter(t=>"!"===t[0]).map(t=>t.slice(1)),s=t.filter(t=>"!"!==t[0]);a.forEach(t=>{s.includes(t.val().toLowerCase())?$(t).data("setter")(FilterBox._PILL_STATES[1]):e.includes(t.val().toLowerCase())?$(t).data("setter")(FilterBox._PILL_STATES[2]):$(t).data("setter")(FilterBox._PILL_STATES[0])})}),r.data("getCounts",function(){const t={yes:0,no:0};return a.forEach(function(e){const s=e.attr("state");void 0!==t[s]&&(t[s]=t[s]+1)}),t}),r}(a);t.headers[s.header].ele=o;const l=function(e){const i=s.minimalUI?"filter-minimal":"",a=$(`<div class="h-wrap ${i}"/>`);$(`<div>${n?`<span class="text-muted">${n}: </span>`:""}${s.header}</div>`).appendTo(a);function r(t,e){const s=$(` <button class="btn btn-default btn-xs ${i}" style="width: 3em;" title="${e}">${t}</button>`).data("andor",t);return s.on(EVNT_CLICK,()=>{const t="OR"===s.data("andor")?"AND":"OR";s.data("andor",t),s.text(t)})}const o=r("OR","Positive matches mode for this filter. AND requires all blues to match, OR requires at least one blue to match.");t.headers[s.header].getAndOrBlue=(()=>o.data("andor"));const l=r("OR","Negative match mode for this filter. AND requires all reds to match, OR requires at least one red to match.");t.headers[s.header].getAndOrRed=(()=>l.data("andor"));const d=$('<span class="btn-group quick-btns" style="margin-left: auto;"/>').appendTo(a),h=$(`<button class="btn btn-default btn-xs ${i}">All</button>`).appendTo(d),u=$(`<button class="btn btn-default btn-xs ${i}">Clear</button>`).appendTo(d),c=$(`<button class="btn btn-default btn-xs ${i}">None</button>`).appendTo(d),f=$(`<button class="btn btn-default btn-xs ${i}">Default</button>`).appendTo(d),p=$('<span class="btn-group andor-btns"></span>');p.append(o).append(l),a.append('<div style="display: inline-block; width: 5px;">').append(p);const m=$('<span class="summary"/>').appendTo(a),_=$('<span class="include" title="Hiding includes"/>').appendTo(m),x=$('<span class="spacer"/>').appendTo(m),g=$('<span class="exclude" title="Hidden excludes"/>').appendTo(m);m.hide();const b=$(`<button class="btn btn-default btn-xs show-hide-button ${i}" style="margin-left: 5px;">Hide</button>`).appendTo(a);return b.on(EVNT_CLICK,function(){if(e.is(":hidden"))b.text("Hide"),e.show(),d.show(),p.css("margin-left",""),m.hide();else{b.text("Show"),e.hide(),d.hide(),p.css("margin-left","auto");const t=e.data("getCounts")();t.yes>0||t.no>0?(t.yes>0?(_.prop("title",`${t.yes} hidden 'required' tag${t.yes>1?"s":""}`),_.text(t.yes),_.show()):_.hide(),t.yes>0&&t.no>0?x.show():x.hide(),t.no>0?(g.prop("title",`${t.no} hidden 'excluded' tag${t.no>1?"s":""}`),g.text(t.no),g.show()):g.hide(),p.css("margin-left","auto"),m.show()):p.css("margin-left","auto")}}),c.on(EVNT_CLICK,function(){e.find(".filter-pill").each(function(){$(this).data("setter")(FilterBox._PILL_STATES[2])})}),h.on(EVNT_CLICK,function(){e.find(".filter-pill").each(function(){$(this).data("setter")(FilterBox._PILL_STATES[1])})}),u.on(EVNT_CLICK,function(){e.find(".filter-pill").each(function(){$(this).data("setter")(FilterBox._PILL_STATES[0])})}),f.on(EVNT_CLICK,function(){t._reset(s.header)}),a}(o);return r.append(l),r.append(o),r}}function d(){return $('<div class="pill-grid-divider"/>')}i.prepend(s),this.$rendered.push(s),i.append(n),this.$rendered.push(n),i.after(this.$miniView),this.$rendered.push(this.$miniView),function(t){const e=$("#filter-toggle-btn");new MutationObserver(function(s){s.forEach(function(s){e.hasClass("open")?(t.$list.parent().append(t.$disabledOverlay),n.show(),t.dropdownVisible=!0):(t.$disabledOverlay.detach(),t.dropdownVisible=!1,n.hide(),t._fireValChangeEvent())})}).observe(e[0],{attributes:!0,attributeFilter:["class"]}),n.on(EVNT_CLICK,function(t){t.stopPropagation()})}(this),t&&(function(t){null!==t.resetButton&&void 0!==t.resetButton&&t.resetButton.addEventListener(EVNT_CLICK,function(){t.reset()},!1)}(this),function(t){window.addEventListener("beforeunload",function(){const e=t.getValues();StorageUtil.setForPage(FilterBox._STORAGE_NAME,e)})}(this)),this.dropdownVisible&&s.find("button").click()}getValues(){const t={};for(const e in this.headers)this.headers.hasOwnProperty(e)&&(t[e]=this.headers[e].ele.data("getValues")());return t}addEventListener(t,e,s){this.inputGroup.addEventListener(t,e,s)}reset(){for(const t in this.headers)this.headers.hasOwnProperty(t)&&this._reset(t);this._fireValChangeEvent()}setFromSubHashes(t){const e={};t.forEach(t=>Object.assign(e,UrlUtil.unpackSubHash(t,!0)));const s={};Object.keys(this.headers).forEach(t=>{s[t.toLowerCase()]=this.headers[t]});const i=[];if(Object.keys(e).filter(t=>t.startsWith(FilterBox._SUB_HASH_PREFIX)).forEach(t=>{const n=t.substring(6);if(!s[n])throw new Error(`Could not find filter with header ${n} for subhash ${t}`);i.push(t),s[n].ele.data("setValues")(e[t])}),i.length){const[t,...s]=History._getHashParts(),n=[];Object.keys(e).filter(t=>!i.includes(t)).forEach(t=>{n.push(`${t}${HASH_SUB_KV_SEP}${e[t].join(HASH_SUB_LIST_SEP)}`)}),History.setSuppressHistory(!0),window.location.hash=`#${t}${n.length?`${HASH_PART_SEP}${n.join(HASH_PART_SEP)}`:""}`,this._fireValChangeEvent()}}setFromValues(t){Object.keys(this.headers).forEach(e=>{if(t[e]){const s=this.headers[e],i=t[e];s.ele.data("setValues")(i)}})}getAsSubHashes(){const t=this.getValues(),e={};return Object.keys(t).forEach(s=>{const i=t[s],n=`${FilterBox._SUB_HASH_PREFIX}${s}`;null!=i.min&&null!=i.max?e[n]=[`min${i.min}`,`max${i.max}`]:i._totals.yes||i._totals.no?(e[n]=[],Object.keys(i).forEach(t=>{if(t.startsWith("_"))return;const s=i[t];s&&e[n].push(`${s<0?"!":""}${t}`)})):e[n]=[HASH_SUB_NONE]}),e}toDisplay(t,...e){const s=this.filterList.map((s,i)=>s.isMulti?s.toDisplay(t,...e[i]):s.toDisplay(t,e[i]));return"AND"===this.modeAndOr?s.every(t=>t):s.find(t=>t)}setCount(t,e){this.$txtCount.html(`Showing ${t}/${e}`)}_reset(t){const e=this.headers[t];e.filter instanceof RangeFilter?e.ele.data("resetValues")():e.ele.find(".filter-pill").each(function(){$(this).data("resetter")()})}_fireValChangeEvent(){const t=new Event(FilterBox.EVNT_VALCHANGE);this.inputGroup.dispatchEvent(t)}_wipeRendered(){this.$rendered.forEach(t=>t.remove()),this.$rendered=[],this.$disabledOverlay.detach()}static nextIfHidden(t){if(History.lastLoadedId&&!History.initialLoad){const e=t[History.lastLoadedId],s=UrlUtil.autoEncodeHash(e);$("#listcontainer").find(`.list a[href="#${s.toLowerCase()}"]`).length||History._freshLoad()}}}FilterBox.CLS_INPUT_GROUP_BUTTON="input-group-btn",FilterBox.CLS_DROPDOWN_MENU="dropdown-menu",FilterBox.CLS_DROPDOWN_MENU_FILTER="dropdown-menu-filter",FilterBox.EVNT_VALCHANGE="valchange",FilterBox.SOURCE_HEADER="Source",FilterBox._PILL_STATES=["ignore","yes","no"],FilterBox._STORAGE_NAME="filterState",FilterBox._SUB_HASH_PREFIX="filter";class Filter{constructor(t){this.header=t.header,this.items=t.items?t.items:[],this.displayFn=t.displayFn,this.selFn=t.selFn,this.deselFn=t.deselFn,this.attrName=t.attrName,this.minimalUI=t.minimalUI}addIfAbsent(t){t&&(t instanceof Array?t.forEach(t=>this.addIfAbsent(t)):this.items.find(e=>Filter._checkMatches(e,t))||this.items.push(t))}static _checkMatches(t,e){return t instanceof FilterItem?t.item===(e instanceof FilterItem?e.item:e):t===(e instanceof FilterItem?e.item:e)}removeIfExists(t){const e=this.items.findIndex(e=>Filter._checkMatches(e,t));~e&&this.items.splice(e,1)}toDisplay(t,e){const s=t[this.header],i=s._totals;function n(t){return t instanceof FilterItem?t.item:t}if(e instanceof Array){let t=!1,a=!1;if("OR"===s._andOr.blue)0===i.yes&&(a=!0),e.forEach(t=>{1===s[n(t)]&&(a=!0)});else{let t=0;e.forEach(e=>{1===s[n(e)]&&t++}),a=!i.yes||i.yes===t}if("OR"===s._andOr.red)e.forEach(e=>{-1===s[n(e)]&&(t=!0)});else{let a=0;e.forEach(t=>{-1===s[n(t)]&&a++}),t=i.no&&i.no===a}return a&&!t}return function(){let t=!1,a=!1;t="OR"===s._andOr.blue?!(i.yes>0)||1===s[n(e)]:!(i.yes>0)||1===s[n(e)]&&1===i.yes;"OR"===s._andOr.red?i.no>0&&(a=-1===s[n(e)]):a=1===i.no&&-1===s[n(e)];return t&&!a}()}}class FilterItem{constructor(t,e,s){this.item=t,this.changeFn=e,this.group=s}}class RangeFilter extends Filter{constructor(t){super(t),this.min=null,this.max=null}addIfAbsent(t){if(null===this.min&&null===this.max)this.min=this.max=t;else{const e=this.min,s=this.max;if(this.min=Math.min(this.min,t),this.max=Math.max(this.max,t),this.$slider){const[t,i]=this.$slider.slider("getValue"),n=t===e&&this.min!==e,a=i===s&&this.max!==s;n&&this.$slider.slider("setAttribute","min",this.min),a&&this.$slider.slider("setAttribute","max",this.max),n&&a?this.$slider.slider("setValue",[this.min,this.max]):n?this.$slider.slider("setValue",[this.min,i]):a&&this.$slider.slider("setValue",[t,this.max])}}}toDisplay(t,e){const s=t[this.header];return null==e?s.min===this.min&&s.max===this.max:e instanceof Array?s.min<=Math.min(...e)&&s.max>=Math.max(...e):s.min<=e&&s.max>=e}}class GroupedFilter extends Filter{constructor(t){super(t),this.numGroups=1,this.groupFn=t.groupFn}}class MultiFilter{constructor(t,...e){this.categoryName=t,this.filters=e,this.isMulti=!0,this.mode="or"}setModeAnd(){this.mode="and"}setModeOr(){this.mode="or"}toDisplay(t,...e){if(this.filters.length!==e.length)throw new Error("Number of filters and number of toChecks did not match");const s=[];for(let i=0;i<this.filters.length;++i){const n=this.filters[i];if(n instanceof RangeFilter)s.push(this.filters[i].toDisplay(t,e[i]));else{const a=t[n.header]._totals;0===a.yes&&0===a.no?s.push(null):s.push(this.filters[i].toDisplay(t,e[i]))}}const i=s.filter(t=>null!==t);return"or"===this.mode?!i.length||i.find(t=>t):i.filter(t=>t).length===i.length}}Filter.deselAll=function(t){return!0};