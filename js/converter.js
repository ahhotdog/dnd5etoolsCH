"use strict";const JSON_URL="data/bestiary/index.json";function moveon(e){return!e.toUpperCase().indexOf("ACTIONS")||!e.toUpperCase().indexOf("LEGENDARY ACTIONS")||!e.toUpperCase().indexOf("REACTIONS")}function tryConvertNumber(e){try{return Number(e)}catch(t){return e}}function tryParseType(e){try{const t=/^(.*?) (\(.*?\))\s*$/.exec(e);return t?{type:t[1].toLowerCase(),tags:t[2].split(",").map(e=>e.replace(/\(/g,"").replace(/\)/g,"").trim().toLowerCase())}:e.toLowerCase()}catch(t){return e}}function tryGetStat(e){try{return tryConvertNumber(/(\d+) \(.*?\)/.exec(e)[1])}catch(e){return 0}}function tryParseSpecialDamage(e,t){const n=e.toLowerCase().split(";"),s=[];try{return n.forEach(e=>{const n={};let i=s;e.includes("from")&&(n[t]=[],i=n[t],n.note=/from .*/.exec(e)[0],e=/(.*) from /.exec(e)[1]),(e=e.replace(/and/g,"")).split(",").forEach(e=>{i.push(e.trim())}),"note"in n&&s.push(n)}),s}catch(t){return e}}function tryParseSpellcasting(e){let t=[];function n(e){function t(e){const t=getSpellSource(e);return`${t&&t!==SRC_PHB?`|${t}`:""}`}let n=(e=e.trim()).indexOf("*"),s=e.indexOf(" (");if(-1!==n){const s=e.substr(0,n);return`{@spell ${s}${t(s)}}*`}if(-1!==s){const n=e.substr(0,s);return`{@spell ${n}${t(n)}}${e.substring(s)}`}return`{@spell ${e}${t(e)}}`}function s(e){return e.replace(/( \+)(\d+)( to hit with spell)/g,(e,t,n,s)=>` {@hit ${n}}${s}`)}try{return function(e){const i=new RegExp(/,\s?(?![^(]*\))/,"g");let r={name:e.name,headerEntries:[s(e.entries[0])]},a=!1;for(let t=1;t<e.entries.length;t++){let l=e.entries[t];if(l.includes("/rest")){a=!0;let e=l.substr(0,1)+(l.includes(" each:")?"e":""),t=l.substring(l.indexOf(": ")+2).split(i).map(e=>n(e));r.rest||(r.rest={}),r.rest[e]=t}else if(l.includes("/day")){a=!0;let e=l.substr(0,1)+(l.includes(" each:")?"e":""),t=l.substring(l.indexOf(": ")+2).split(i).map(e=>n(e));r.daily||(r.daily={}),r.daily[e]=t}else if(l.includes("/week")){a=!0;let e=l.substr(0,1)+(l.includes(" each:")?"e":""),t=l.substring(l.indexOf(": ")+2).split(i).map(e=>n(e));r.weekly||(r.weekly={}),r.weekly[e]=t}else if(l.startsWith("Constant: "))a=!0,r.constant=l.substring(9).split(i).map(e=>n(e));else if(l.startsWith("At will: "))a=!0,r.will=l.substring(9).split(i).map(e=>n(e));else if(l.includes("Cantrip")){a=!0;let e=l.substring(l.indexOf(": ")+2).split(i).map(e=>n(e));r.spells||(r.spells={0:{spells:[]}}),r.spells[0].spells=e}else if(l.includes(" level")&&l.includes(": ")){a=!0;let e=l.substr(0,1),t=l.substring(l.indexOf(": ")+2).split(i).map(e=>n(e));r.spells||(r.spells={});let s=l.includes(" slot")?parseInt(l.substr(11,1)):0;r.spells[e]={slots:s,spells:t}}else a?(r.footerEntries||(r.footerEntries=[]),r.footerEntries.push(s(l))):r.headerEntries.push(s(l))}t.push(r)}(e),{out:t,success:!0}}catch(t){return{out:e,success:!1}}}window.onload=loadSources;const SKILL_SPACE_MAP={sleightofhand:"sleight of hand",animalhandling:"animal handling"},ALIGNMENT_MAP={"any non-good alignment":["L","NX","C","NY","E"],"any non-lawful alignment":["NX","C","G","NY","E"],"any chaotic alignment":["C","G","NY","E"],"any evil alignment":["L","NX","C","E"],"any alignment":["A"],unaligned:["U"],neutral:["N"],"chaotic evil":["C","E"],"chaotic neutral":["C","N"],"chaotic good":["C","G"],"neutral good":["N","G"],"neutral evil":["N","E"],"lawful evil":["L","E"],"lawful neutral":["L","N"],"lawful good":["L","G"]},SPELL_SRC_MAP={};function getSpellSource(e){return e&&SPELL_SRC_MAP[e.toLowerCase()]?SPELL_SRC_MAP[e.toLowerCase()]:null}function loadSources(){DataUtil.loadJSON("data/spells/index.json").then(e=>Promise.all(Object.values(e).map(e=>DataUtil.loadJSON(`data/spells/${e}`)))).then(e=>{e.reverse().forEach(e=>e.spell.forEach(e=>SPELL_SRC_MAP[e.name.toLowerCase()]=e.source)),DataUtil.loadJSON(JSON_URL).then(loadparser)})}function sortOptions(e){e.append(e.find("option").remove().sort((e,t)=>{const n=$(e).text(),s=$(t).text();return n>s?1:n<s?-1:0}))}function appendSource(e,t){e.append(`<option value="${t}">${t}</option>`)}const COOKIE_NAME="converterSources";function loadparser(e){let t=!1;const n=$("#source");Object.keys(e).forEach(e=>appendSource(n,e));const s=Cookies.get(COOKIE_NAME),i=s?JSON.parse(s):{sources:[],selected:SRC_MM};i.sources.forEach(e=>appendSource(n,e)),sortOptions(n),n.val(i.selected),n.on("change",()=>i.selected=n.val()),window.addEventListener("unload",function(){Cookies.set(COOKIE_NAME,i,{expires:365,path:window.location.pathname})});const r=$("#customsourcein");$("#addsource").on("click",()=>{const e=r.val().trim();i.sources.find(t=>e.toLowerCase()===t.toLowerCase())||(i.selected=e,i.sources.push(e),appendSource(n,e),sortOptions(n),n.val(e),r.val(""))});const a=ace.edit("statblock");function l(e){return e.replace(/[−–]/g,"-")}function o(e){return e.toLowerCase().replace(/\b\w/g,function(e){return e.toUpperCase()})}function c(e,t){e.size=t[0].toUpperCase(),e.type=t.split(",")[0].split(" ").splice(1).join(" "),e.type=tryParseType(e.type),e.alignment=t.split(", ")[1].toLowerCase(),e.alignment=ALIGNMENT_MAP[e.alignment]||e.alignment}function u(e,t){const n=t.split("Hit Points ")[1],s=/^(\d+) \((.*?)\)$/.exec(n);e.hp=s?{average:Number(s[1]),formula:s[2]}:{special:n}}function p(e,t){t=t.toLowerCase().trim().replace(/^speed\s*/,"");const n=["walk","fly","swim","climb","burrow"];const s={};let i=!1;(function(e){let t,n=[],s="",i=0;for(let r=0;r<e.length;++r)switch(t=e.charAt(r)){case",":0===i&&(n.push(s),s="");break;case"(":i++,s+=t;break;case")":i--,s+=t;break;default:s+=t}return s&&n.push(s),n.map(e=>e.trim()).filter(e=>e)})(t.toLowerCase()).map(e=>e.trim()).forEach(e=>{const t=/^(\w+?\s+)?(\d+)\s*ft\.( .*)?$/.exec(e);t?(t[1]?t[1]=t[1].trim():t[1]="walk",n.includes(t[1])?t[3]?s[t[1]]={number:Number(t[2]),condition:t[3].trim()}:s[t[1]]=Number(t[2]):i=!0):i=!0}),Object.values(s).filter(e=>(null!=e.number?e.number:e)%5!=0).length&&(s.INVALID_SPEED=!0),i&&(s.UNPARSED_SPEED=t),e.speed=s}function f(e,t){if(e.save=t.split("Saving Throws")[1].trim(),e.save&&e.save.trim()){const t=e.save.split(",").map(e=>e.trim().toLowerCase()).filter(e=>e),n={};t.forEach(e=>{const t=e.split(" ");n[t[0]]=t[1]}),e.save=n}}function m(e,t){e.skill=t.split("Skills")[1].trim().toLowerCase();const n=e.skill.split(","),s={};try{n.forEach(e=>{const t=e.split(" "),n=t.pop().trim();let i=t.join(" ").toLowerCase().trim().replace(/ /g,"");i=SKILL_SPACE_MAP[i]||i,s[i]=n}),e.skill=s,e.skill[""]&&delete e.skill[""]}catch(e){return 0}}function d(e,t){e.vulnerable=t.split("Vulnerabilities")[1].trim(),e.vulnerable=tryParseSpecialDamage(e.vulnerable,"vulnerable")}function g(e,t){e.resist=(t.includes("Resistances")?t.split("Resistances"):t.split("Resistance"))[1].trim(),e.resist=tryParseSpecialDamage(e.resist,"resist")}function h(e,t){e.immune=t.split("Immunities")[1].trim(),e.immune=tryParseSpecialDamage(e.immune,"immune")}function C(e,t){e.conditionImmune=t.split("Immunities")[1],e.conditionImmune=tryParseSpecialDamage(e.conditionImmune,"conditionImmune")}function y(e,t){e.senses=t.toLowerCase().split("senses")[1].split("passive perception")[0].trim(),e.senses.indexOf("passive perception")||(e.senses=""),","===e.senses[e.senses.length-1]&&(e.senses=e.senses.substring(0,e.senses.length-1)),e.passive=tryConvertNumber(t.toLowerCase().split("passive perception")[1].trim())}function S(e,t){e.languages=t.split("Languages")[1].trim()}function w(e,t){e.cr=t.split("Challenge")[1].trim().split("(")[0].trim()}function b(e){return e&&(e.name||1===e.entries.length&&e.entries[0]||e.entries.length>1)}function O(e){e.entries&&(e.entries=e.entries.filter(e=>e.trim()).map(e=>"string"!=typeof e?e:e=(e=e.replace(/([-+])?\d+(?= to hit)/g,function(e){return`{@hit ${e}}`})).replace(/\d+d\d+(\s?([-+])\s?\d+\s?)?/g,function(e){return`{@dice ${e}}`})))}function L(e){const t=l(a.getValue()).split("\n"),s={};s.source=n.val(),s.page=0;let i=null,r=null;for(let e=0;e<t.length;e++)if(i=r,""!==(r=t[e].trim()))if(0!==e)if(1!==e)if(2!==e)if(3!==e)if(4!==e){if(5!==e)if(6!==e){switch(i.toLowerCase()){case"str":s.str=tryGetStat(r);break;case"dex":s.dex=tryGetStat(r);break;case"con":s.con=tryGetStat(r);break;case"int":s.int=tryGetStat(r);break;case"wis":s.wis=tryGetStat(r);break;case"cha":s.cha=tryGetStat(r)}if(r.indexOf("Saving Throws "))if(r.indexOf("Skills "))if(r.indexOf("Damage Vulnerabilities "))if(r.indexOf("Damage Resistance"))if(r.indexOf("Damage Immunities "))if(r.indexOf("Condition Immunities "))if(r.indexOf("Senses "))if(r.indexOf("Languages ")){if(!r.indexOf("Challenge ")){w(s,r),r=t[++e],s.trait=[],s.action=[],s.reaction=[],s.legendary=[];let n={},i=!0,a=!1,l=!1,o=!1,c=!1;for(;e<t.length;){moveon(r)&&(i=!1,a=!r.toUpperCase().indexOf("ACTIONS"),l=!r.toUpperCase().indexOf("REACTIONS"),c=o=!r.toUpperCase().indexOf("LEGENDARY ACTIONS"),r=t[++e]),n.name="",n.entries=[];const u=e=>{n.name=e.split(/([.!])/g)[0],n.entries.push(e.split(".").splice(1).join(".").trim())};if(c){const e=r.replace(/\s*/g,"").toLowerCase();e.includes("legendary")||e.includes("action")||(c=!1)}for(c?(n.entries.push(r.trim()),c=!1):u(r),r=t[++e];r&&null===r.match(/^(([A-Z0-9ota][a-z0-9'’`]+|[aI])( \(.*\)| )?)+([.!])+/g)&&!moveon(r);)n.entries.push(r.trim()),r=t[++e];(n.name||n.entries)&&(O(n),i&&(n.name.toLowerCase().includes("spellcasting")?(n=tryParseSpellcasting(n)).success?s.spellcasting?s.spellcasting=s.spellcasting.concat(n.out):s.spellcasting=n.out:s.trait.push(n.out):b(n)&&s.trait.push(n)),a&&b(n)&&s.action.push(n),l&&b(n)&&s.reaction.push(n),o&&b(n)&&s.legendary.push(n)),n={}}0===s.trait.length&&delete s.trait,0===s.reaction.length&&delete s.reaction,0===s.legendary.length&&delete s.legendary}}else S(s,r);else y(s,r);else C(s,r);else h(s,r);else g(s,r);else d(s,r);else m(s,r);else f(s,r)}else{const e=r.split(/ \(([+-–‒])?[0-9]*\) ?/g);s.str=tryConvertNumber(e[0]),s.dex=tryConvertNumber(e[2]),s.con=tryConvertNumber(e[4]),s.int=tryConvertNumber(e[6]),s.wis=tryConvertNumber(e[8]),s.cha=tryConvertNumber(e[10])}}else p(s,r);else u(s,r);else s.ac=r.split("Armor Class ")[1];else c(s,r);else s.name=o(r);x(s),N(v(JSON.stringify(s,null,"\t")),e)}function x(e){ConverterUtils.tryPostProcessAc(e)}function v(e){return e.replace(/([1-9]\d*)?d([1-9]\d*)(\s?)([+-])(\s?)(\d+)?/g,"$1d$2$4$6").replace(/\u2014/g,"\\u2014").replace(/\u2013/g,"\\u2014").replace(/’/g,"'").replace(/[“”]/g,'\\"')}function N(e,n){const s=$("textarea#jsonoutput");if(n){const n=s.text();s.text(`${e},\n${n}`),t=!0}else s.text(e),t=!1}function E(e){function t(e){return e.replace(/\**/g,"").replace(/^-/,"").trim()}function s(e){return e.replace(/^###/,"").trim()}function i(e){const t=e.trim().startsWith("*"),n=e.replace(/^[^A-Za-z0-9]*/,"").trim();return t?n.replace(/\*/,""):n}function r(e){return e.trim().startsWith("**")}const L=l(a.getValue()).split("\n");let E=null;let $=0,k=!1;function A(){if(E){x(E),N(v(JSON.stringify(E,null,"\t")),e)}E={source:n.val(),page:0},k&&(e=!0),$=0}let _=null,P=null,I=null,D=!0,R=!0,G=null;function U(e){return e.replace(/^\*\*\*?/,"").split(/.\s*\*\*\*?/).map(e=>e.trim())}function M(){9===$?T():10===$?j():11===$?J():12===$&&V()}function T(){b(G)&&(E.trait=E.trait||[],O(G),G.name.toLowerCase().includes("spellcasting")?(G=tryParseSpellcasting(G)).success?E.spellcasting?E.spellcasting=E.spellcasting.concat(G.out):E.spellcasting=G.out:E.trait.push(G.out):E.trait.push(G)),G=null}function j(){b(G)&&(E.action=E.action||[],O(G),E.action.push(G)),G=null}function J(){b(G)&&(E.reaction=E.reaction||[],O(G),E.reaction.push(G)),G=null}function V(){b(G)&&(E.legendary=E.legendary||[],O(G),E.legendary.push(G)),G=null}let W=0;for(;W<L.length;W++){if(_=I,P=L[W].trim(),""===(I=L[W].trim())||"\\pagebreak"===I.toLowerCase()||"\\columnbreak"===I.toLowerCase()){D=!0;continue}if(R=!1,""===(I=(Y=I,Y.replace(/^\s*>\s*/,"").trim()).trim()))continue;if("___"===I&&D||"___"===P){null!==E&&(k=!0),A(),D=R;continue}if("___"===I){D=R;continue}if(0===$){I=I.replace(/^\s*##/,"").trim(),E.name=o(I),$++;continue}if(1===$){I=I.replace(/^\**(.*?)\**$/,"$1"),c(E,I),$++;continue}if(2===$){E.ac=t(I).replace(/Armor Class/g,"").trim(),$++;continue}if(3===$){u(E,t(I)),$++;continue}if(4===$){p(E,t(I)),$++;continue}if(5===$||6===$||7===$){if(I.replace(/\s*/g,"").startsWith("|STR")||I.replace(/\s*/g,"").startsWith("|:-")){$++;continue}const e=I.split("|").map(e=>e.trim()).filter(Boolean);["str","dex","con","int","wis","cha"].map((t,n)=>E[t]=tryGetStat(e[n])),$++;continue}if(8===$){if(~I.indexOf("Saving Throws")){f(E,t(I));continue}if(~I.indexOf("Skills")){m(E,t(I));continue}if(~I.indexOf("Damage Vulnerabilities")){d(E,t(I));continue}if(~I.indexOf("Damage Resistance")){g(E,t(I));continue}if(~I.indexOf("Damage Immunities")){h(E,t(I));continue}if(~I.indexOf("Condition Immunities")){C(E,t(I));continue}if(~I.indexOf("Senses")){y(E,t(I));continue}if(~I.indexOf("Languages")){S(E,t(I));continue}if(~I.indexOf("Challenge")){w(E,t(I)),$++;continue}}const e=s(I);if("actions"!==e.toLowerCase())if("reactions"!==e.toLowerCase())if("legendary actions"!==e.toLowerCase()){if(9===$)if(r(I)){T(),G={name:"",entries:[]};const[e,t]=U(I);G.name=e,G.entries.push(i(t))}else G.entries.push(i(I));if(10===$)if(r(I)){j(),G={name:"",entries:[]};const[e,t]=U(I);G.name=e,G.entries.push(i(t))}else G.entries.push(i(I));if(11===$)if(r(I)){J(),G={name:"",entries:[]};const[e,t]=U(I);G.name=e,G.entries.push(i(t))}else G.entries.push(i(I));if(12===$)if(r(I)){V(),G={name:"",entries:[]};const[e,t]=U(I);G.name=e,G.entries.push(i(t))}else G?G.entries.push(i(I)):I.toLowerCase().includes("can take 3 legendary actions")||(G={name:"",entries:[i(I)]})}else M(),$=12;else M(),$=11;else M(),$=10}var Y;A()}a.setOptions({wrap:!0}),$("button#parsestatblockadd").on("click",()=>{"txt"===$("#parse_mode").val()?L(!0):E(!0)}),$("button#parsestatblock").on("click",()=>{t&&!confirm("You're about to overwrite multiple entries. Are you sure?")||("txt"===$("#parse_mode").val()?L(!1):E(!1))})}