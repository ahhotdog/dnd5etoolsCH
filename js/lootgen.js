"use strict";const LOOT_JSON_URL="data/loot.json",renderer=new EntryRenderer;let lootList;class LootGen{constructor(){this._spells=null,this._loadingSpells=!1}loadLoot(t){lootList=t,$("button#clear").click(()=>$("#lootoutput").html("")),$("button#genloot").click(lootGen.rollLoot);const e=$("#table-sel");t.magicitems.forEach((t,l)=>{e.append(`<option value="${l}">${t.name}</option>`)}),e.on("change",()=>{const t=e.val();""!==t&&this.displayTable(t)})}displayTable(t){const e=lootList.magicitems[t];let l=`\n\t\t<table id="stats">\n\t\t\t<caption>${e.name}</caption>\n\t\t\t<thead>\n\t\t\t\t<tr>\n\t\t\t\t\t<th class="col-xs-2 text-align-center"><span class="roller" onclick="lootGen.rollAgainstTable(${t});">d100</span></th>\n\t\t\t\t\t<th class="col-xs-10">Magic Item</th>\n\t\t\t\t</tr>\n\t\t\t</thead>`;e.table.forEach(t=>{const e=t.min===t.max?t.min:`${t.min}-${t.max}`;l+=`<tr><td class="text-align-center">${e}</td><td>${lootGen.parseLink(t.item)}</td></tr>`}),l+=`\n\t\t</table>\n\t\t<small><b>Source:</b> <i>${Parser.sourceJsonToFull(e.source)}</i>, page ${e.page}</small>`,$("div#classtable").html(l).show()}rollAgainstTable(t){const e=lootList.magicitems[t];let l=null;const o=lootGen.randomNumber(1,100);for(let t=0;t<e.table.length;t++)o>=e.table[t].min&&o<=e.table[t].max&&(l=e.table[t]);const n=l.table?l.table[lootGen.randomNumber(0,l.table.length-1)]:l.item;l=lootGen.parseLink(n,{rollSpellScroll:!0}),$("#lootoutput > ul:eq(4), #lootoutput > hr:eq(4)").remove(),$("#lootoutput").prepend("<ul></ul><hr>"),$("#lootoutput ul:eq(0)").append("<li>Rolled a "+o+" against "+e.name+":<ul><li>"+l+"</li></ul></li>")}rollLoot(){const t=$("#cr").val(),e=$("#hoard").prop("checked");$("#lootoutput > ul:eq(4), #lootoutput > hr:eq(4)").remove(),$("#lootoutput").prepend("<ul></ul><hr>");const l=e?lootList.hoard:lootList.individual;let o=null;for(let e=0;e<l.length;e++)t>=l[e].mincr&&t<=l[e].maxcr&&(o=l[e]);if(!o)return;const n=lootGen.randomNumber(1,100),s=o.table;let r=null;for(let t=0;t<s.length;t++)n>=s[t].min&&n<=s[t].max&&(r=s[t]);if(r)if(e){const t=[];t.push(lootGen.getFormattedCoinsForDisplay(o.coins));const e=r.gems?r.gems:r.artobjects?r.artobjects:null;if(e){let t=r.artobjects?lootList.artobjects:lootList.gemstones;for(let l=0;l<t.length;l++)t[l].type===e.type&&(t=t[l]);const l=EntryRenderer.dice.parseRandomise(e.amount).total,o=[];for(let e=0;e<l;e++)o.push(t.table[lootGen.randomNumber(0,t.table.length-1)]);$("#lootoutput ul:eq(0)").append("<li>"+(l>1?"x"+l+" ":"")+Parser._addCommas(e.type)+" gp "+(r.artobjects?"art object":"gemstone")+(l>1?"s":"")+":<ul>"+lootGen.sortArrayAndCountDupes(o)+"</ul></li>")}if(r.magicitems){const t=[],e=[];t.push(r.magicitems.type.split(",")[0]),e.push(r.magicitems.amount.split(",")[0]),-1!==r.magicitems.type.indexOf(",")&&(t.push(r.magicitems.type.split(",")[1]),e.push(r.magicitems.amount.split(",")[1]));for(let l=0;l<t.length;l++){const o=t[l],n=e[l];let s=lootList.magicitems,r=0;for(let t=0;t<s.length;t++)s[t].type===o&&(s=s[r=t]);const a=EntryRenderer.dice.parseRandomise(n).total,i=[];for(let t=0;t<a;t++){let t=null;const e=lootGen.randomNumber(1,100);for(let l=0;l<s.table.length;l++)e>=s.table[l].min&&e<=s.table[l].max&&(t=s.table[l]);const l=t.table?lootGen.randomNumber(0,t.table.length-1):null,o=t.table?t.table[l]:t.item;i.push({result:lootGen.parseLink(o,{rollSpellScroll:!0}),roll:e})}$("#lootoutput ul:eq(0)").append("<li>"+(i.length>1?"x"+i.length+" ":"")+"Magic Item"+(a>1?"s":"")+` (<a onclick="lootGen.displayTable(${r});">Table ${o}</a>):<ul>${lootGen.sortArrayAndCountDupes(i)}</ul></li>`)}}for(let e=0;e<t.length;e++)$("#lootoutput ul:eq(0)").prepend(`<li>${t[e]}</li>`)}else $("#lootoutput ul:eq(0)").prepend(`<li>${lootGen.getFormattedCoinsForDisplay(r.coins)}</li>`)}sortArrayAndCountDupes(t){let e=[];function l(){return e.length?` <span class="text-muted">(Rolled ${e.join(", ")})</span>`:""}t.sort();let o=null,n=0,s="";return t.forEach(t=>{(t.result||t)!==o?(n>0&&(s+=`<li>${n>1?`x${n} `:""}${o}${l()}</li>`),o=t.result||t,n=1,e=null!=t.roll?[t.roll]:[]):n++}),n>0&&(s+=`<li>${n>1?`x${n} `:""}${o}${l()}</li>`),s}getFormattedCoinsForDisplay(t){const e=lootGen.generateCoinsFromLoot(t),l=[];return e.forEach(t=>{l.unshift(`<li>${Parser._addCommas(t.value)} ${t.denomination}</li>`)}),`${Parser._addCommas(lootGen.getGPValueFromCoins(e))} gp total:<ul> ${l.reduce((t,e)=>t+e,"")}</ul>`}generateCoinsFromLoot(t){const e=[],l=[t.cp,t.sp,t.ep,t.gp,t.pp],o=["cp","sp","ep","gp","pp"];for(let t=l.length-1;t>=0;t--){if(!l[t])continue;const n=l[t].split("*")[1];let s=EntryRenderer.dice.parseRandomise(l[t].split("*")[0]).total;n&&(s*=parseInt(n));const r={denomination:o[t],value:s};e.push(r)}return e}getGPValueFromCoins(t){const e=t.reduce((t,e)=>{switch(e.denomination){case"cp":return t+.01*e.value;case"sp":return t+.1*e.value;case"ep":return t+.5*e.value;case"gp":return t+e.value;case"pp":return t+10*e.value;default:return t}},0);return parseFloat(e.toFixed(2))}randomNumber(t,e){return RollerUtil.randomise(e,t)}_getOrViewSpellsPart(t){return renderer.renderEntry(`{@filter see all ${Parser.spLevelToFullLevelText(t,!0)} spells|spells|level=${t}}`)}parseLink(t,e={}){if(-1!==t.indexOf("{@item ")){const l=[];if(renderer.recursiveEntryRender(t,l),e.rollSpellScroll&&t.toLowerCase().startsWith("{@item spell scroll")){const e=/spell scroll \((.*?)\)/.exec(t.toLowerCase()),o="cantrip"===e[1]?0:Number(e[1][0]);this.hasLoadedSpells()?l.push(` <i>(<span>${renderer.renderEntry(this.getRandomSpell(o))}</span> or ${this._getOrViewSpellsPart(o)})</i>`):l.push(` <i>(<span class="roller" onclick="lootGen.loadRollSpell.bind(lootGen)(this, ${o})">roll</span> or ${this._getOrViewSpellsPart(o)})</i>`)}return l.join("")}return t}hasLoadedSpells(){return!!this._spells&&!this._loadingSpells}loadSpells(t){this._loadingSpells||(this._loadingSpells=!0,DataUtil.loadJSON("data/spells/index.json").then(t=>Promise.all(Object.values(t).map(t=>DataUtil.loadJSON(`data/spells/${t}`)))).then(e=>{this._spells={};const l=t=>{this._spells[t.level]=this._spells[t.level]||[],this._spells[t.level].push(`{@spell ${t.name}|${t.source}}`)};e.forEach(t=>{t.spell.filter(t=>!SourceUtil.isNonstandardSource(t.source)).forEach(t=>l(t))}),BrewUtil.pAddBrewData().then(e=>{e&&e.spell&&e.spell.forEach(t=>l(t)),this._loadingSpells=!1,t()}).catch(BrewUtil.purgeBrew)}))}loadRollSpell(t,e){const l=()=>{$(t).removeClass("roller").attr("onclick","").html(`${renderer.renderEntry(this.getRandomSpell(e))}`)};this.hasLoadedSpells()?l():($(t).html("[loading...]"),this.loadSpells(()=>l()))}getRandomSpell(t){const e=this._spells[t];return e[this.randomNumber(0,e.length-1)]}}const lootGen=new LootGen;window.onload=function(){DataUtil.loadJSON(LOOT_JSON_URL).then(lootGen.loadLoot.bind(lootGen))};